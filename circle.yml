machine:
  environment:
    DMD: 2.071.0
    DUB: 0.9.24
    PATH: "${HOME}/dmd2/linux/bin64:${PATH}"
    LD_LIBRARY_PATH: "${HOME}/dmd2/linux/lib64:${LD_LIBRARY_PATH}"
checkout:
  post:
    - git submodule sync . && git submodule update --recursive --init || true
    - git submodule sync . && git submodule update --recursive --init || true # duplication needed due to circleci bug, don't remove
dependencies:
  override:
    - curl -fsSL --retry 3 "http://downloads.dlang.org/releases/2.x/$DMD/dmd.$DMD.linux.tar.xz" | tar -C ~ -Jxf -
    - curl -fsSL --retry 3 http://code.dlang.org/files/dub-${DUB}-linux-x86_64.tar.gz | tar -C ~/dmd2/linux/bin64 -zxf -
    - dmd --version
    - dub --version
    - wget -q -O dscanner "http://releases.dlang.io/dscanner/0.3.0-git/dscanner"
    - chmod +x dscanner
test:
  override:
    - dscanResult=$(./dscanner --config .dscanner.ini --styleCheck $(find source/mir/* -type d | grep -v ndslice | tr '\n' ' ') 2> /dev/null ) ; if [ -z "${dscanResult}" ] ; then echo "No warnings found" ; else echo $dscanResult && $(exit 1); fi
    - dub test
    - dmd -c -o- -version=CoreDdoc -version=StdDdoc -Df.release-dummy.html -Xfdocs.json -Isource $(find source -name '*.d' | tr '\n' ' ')
    - git clone https://github.com/dlang/dlang.org
    - (cd dlang.org/dpl-docs && dub build)
    - DLANGORG=./dlang.org ${DLANGORG}/dpl-docs/dpl-docs generate-html --file-name-style=lowerUnderscored --std-macros=${DLANGORG}/html.ddoc --std-macros=${DLANGORG}/dlang.org.ddoc --std-macros=${DLANGORG}/std.ddoc --std-macros=${DLANGORG}/macros.ddoc --std-macros=${DLANGORG}/std-ddox.ddoc --override-macros=${DLANGORG}/std-ddox-override.ddoc --package-order=std --git-target=master docs.json docs
    - cp -R ./dlang.org/css css
deployment:
  aws:
    branch: master
    commands:
      - AWS_DEFAULT_REGION=eu-west-1 aws s3 sync --acl public-read --delete docs s3://docs.mir.dlang.io/latest
      - AWS_DEFAULT_REGION=eu-west-1 aws s3 sync --acl public-read --delete css s3://docs.mir.dlang.io/css
